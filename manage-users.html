<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช - ูููู ูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="css/responsive.css">
    <script src="js/theme.js"></script>
    <!-- Configuration -->
    <script src="./js/config.js"></script>
    <!-- Environment Variables -->
    <script src="./js/env-loader.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/supabase-config.js"></script>
    <script src="./db-manager.js"></script>
    <script src="./js/dashboard-manager.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #1a1a1a;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* ุชุญุณููุงุช ุดุงููุฉ ููุฌูุงูุงุช */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem !important;
                margin: 0 !important;
            }
            
            /* ุชุญุณูู ุงูุนููุงู ูุงูุฃุฒุฑุงุฑ */
            .flex.justify-between.items-center {
                flex-direction: column !important;
                gap: 1rem !important;
                align-items: stretch !important;
            }
            
            .flex.justify-between.items-center h1 {
                text-align: center !important;
                font-size: 1.5rem !important;
            }
            
            .flex.justify-between.items-center a {
                width: 100% !important;
                text-align: center !important;
                justify-content: center !important;
            }
            
            /* ุชุญุณูู ุงูุฅุญุตุงุฆูุงุช */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .stats-grid > div {
                padding: 1rem !important;
            }
            
            .stats-grid h3 {
                font-size: 0.875rem !important;
            }
            
            .stats-grid p {
                font-size: 1.5rem !important;
            }
            
            /* ุชุญุณูู ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช */
            .flex.gap-4.items-center {
                flex-direction: column !important;
                gap: 1rem !important;
                align-items: stretch !important;
            }
            
            .flex.gap-4.items-center button {
                width: 100% !important;
                justify-content: center !important;
            }
            
            .flex.gap-4.items-center .relative {
                width: 100% !important;
            }
            
            .flex.gap-4.items-center input {
                width: 100% !important;
            }
            
            .flex.gap-4.items-center select {
                width: 100% !important;
            }
            
            /* ุฅุฎูุงุก ุงูุฌุฏูู ูุฅุธูุงุฑ ุงูุจุทุงูุงุช */
            .desktop-table {
                display: none !important;
            }
            
            .mobile-view {
                display: block !important;
            }
            
            /* ุชุญุณูู ุงูุจุทุงูุงุช ุงููุญูููุฉ */
            .mobile-card {
                background: #2a2a2a;
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                border: 1px solid #3a3a3a;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
            
            .mobile-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #3a3a3a;
            }
            
            .mobile-card-title {
                font-weight: 600;
                color: #fff;
                font-size: 1rem;
                word-break: break-word;
                flex: 1;
                margin-left: 0.5rem;
            }
            
            .mobile-card-body {
                display: grid;
                gap: 0.75rem;
            }
            
            .mobile-field {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 0.5rem 0;
                border-bottom: 1px solid #3a3a3a;
            }
            
            .mobile-field:last-child {
                border-bottom: none;
            }
            
            .mobile-field-label {
                color: #9ca3af;
                font-size: 0.875rem;
                font-weight: 500;
                flex: 1;
            }
            
            .mobile-field-value {
                color: #fff;
                font-size: 0.875rem;
                text-align: left;
                flex: 1;
                word-break: break-word;
            }
            
            .mobile-actions {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #3a3a3a;
            }
            
            .mobile-actions button {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.25rem;
                min-height: 44px;
            }
            
            /* ุชุญุณูู ุงูููุงูุฐ ุงูููุจุซูุฉ */
            .fixed.inset-0 {
                padding: 1rem !important;
            }
            
            .modal-content {
                margin: 0 !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                border-radius: 12px !important;
            }
            
            .modal-content h3 {
                font-size: 1.25rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* ุชุญุณูู ุงูููุงุฐุฌ */
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .form-grid input,
            .form-grid select,
            .form-grid textarea {
                width: 100% !important;
                padding: 0.75rem !important;
                font-size: 1rem !important;
                border-radius: 8px !important;
            }
            
            .button-group {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .button-group button {
                width: 100% !important;
                padding: 0.75rem !important;
                font-size: 1rem !important;
                min-height: 48px !important;
            }
            
            /* ุชุญุณูู ุงูููุงุญุธุงุช ุงูุชูุถูุญูุฉ */
            .bg-blue-900\/30 {
                padding: 0.75rem !important;
                margin-bottom: 1rem !important;
            }
            
            .bg-blue-900\/30 .grid {
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
            }
            
            .bg-blue-900\/30 .text-xs {
                font-size: 0.75rem !important;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-view {
                display: none !important;
            }
            
            .desktop-table {
                display: table !important;
            }
        }
        
        /* ุชุญุณููุงุช ููุดุงุดุงุช ุงูุตุบูุฑุฉ ุฌุฏุงู */
        @media (max-width: 480px) {
            .container {
                padding: 0.5rem !important;
            }
            
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
            }
            
            .stats-grid > div {
                padding: 0.75rem !important;
            }
            
            .mobile-card {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .mobile-card-title {
                font-size: 0.9rem;
            }
            
            .mobile-field {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
                padding: 0.5rem 0;
            }
            
            .mobile-field-label {
                font-size: 0.8rem;
                font-weight: 600;
            }
            
            .mobile-field-value {
                text-align: right;
                width: 100%;
                font-size: 0.8rem;
            }
            
            .mobile-actions {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .mobile-actions button {
                padding: 0.75rem;
                font-size: 0.8rem;
            }
            
            .flex.justify-between.items-center h1 {
                font-size: 1.25rem !important;
            }
        }
        
        /* ุชุญุณููุงุช ูููุถุน ุงูุฃููู ุนูู ุงูุฌูุงูุงุช */
        @media (max-width: 768px) and (orientation: landscape) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            
            .mobile-card {
                padding: 0.75rem;
            }
            
            .mobile-actions {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* ุชุญุณููุงุช ููุดุงุดุงุช ุงููุชูุณุทุฉ */
        @media (min-width: 481px) and (max-width: 768px) {
            .mobile-actions {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* ุชุฃุซูุฑุงุช ุงูุชูุงุนู ุงููุญุณูุฉ ููุฌูุงูุงุช */
        @media (hover: none) and (pointer: coarse) {
            button, .btn, input, select {
                min-height: 44px;
                min-width: 44px;
            }
            
            .mobile-actions button {
                padding: 0.75rem 1rem;
                min-height: 48px;
            }
            
            /* ุชุญุณูู ุญุฌู ุงููุต ูููุณ */
            input, select, textarea {
                font-size: 16px !important; /* ููุน ุงูุชูุจูุฑ ุงูุชููุงุฆู ูู iOS */
            }
            
            /* ุชุญุณูู ุงููุณุงูุงุช ูููุณ */
            .mobile-field {
                min-height: 44px;
            }
        }
        
        /* ุชุญุณููุงุช ุฅุถุงููุฉ ูููุตูููุฉ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="bg-[#1a1a1a] text-white overflow-x-hidden">
    <!-- ุฒุฑ ุงูุฑุฌูุน ูุนููุงู ุงูุตูุญุฉ -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold">ุฅุฏุงุฑุฉ ุญุณุงุจุงุช ุงููุณุชุฎุฏููู</h1>
            <a href="dashboard.html" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700 flex items-center gap-2">
                <i class="fas fa-arrow-right"></i>
                ุงูุฑุฌูุน ูููุญุฉ ุงูุชุญูู
            </a>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 stats-grid">
            <div class="bg-[#2a2a2a] p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-gray-400">ุฅุฌูุงูู ุงูุญุณุงุจุงุช</h3>
                        <p class="text-2xl font-bold" id="totalAccounts">0</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>
            <div class="bg-[#2a2a2a] p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-gray-400">ุญุณุงุจุงุช ูุดุทุฉ</h3>
                        <p class="text-2xl font-bold text-green-500" id="activeAccounts">0</p>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-green-500"></i>
                </div>
            </div>
            <div class="bg-[#2a2a2a] p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-gray-400">ุชูุชูู ูุฑูุจุงู</h3>
                        <p class="text-2xl font-bold text-yellow-500" id="expiringAccounts">0</p>
                    </div>
                    <i class="fas fa-clock text-3xl text-yellow-500"></i>
                </div>
            </div>
            <div class="bg-[#2a2a2a] p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-gray-400">ุญุณุงุจุงุช ููุชููุฉ</h3>
                        <p class="text-2xl font-bold text-red-500" id="expiredAccounts">0</p>
                    </div>
                    <i class="fas fa-times-circle text-3xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- ุฃุฏูุงุช ุงูุชุญูู -->
        <div class="flex justify-between items-center mb-6">
            <button onclick="openNewUserModal()" 
                    class="bg-green-600 px-6 py-3 rounded-lg hover:bg-green-700 flex items-center gap-2">
                <i class="fas fa-user-plus"></i>
                ุฅุถุงูุฉ ุญุณุงุจ ุฌุฏูุฏ
            </button>
            <div class="flex gap-4 items-center">
                <div class="relative">
                    <input type="text" 
                           id="searchInput" 
                           placeholder="ุจุญุซ ุนู ูุณุชุฎุฏู..." 
                           onkeyup="filterUsers()"
                           class="w-64 p-2 rounded bg-[#1a1a1a] border border-gray-700 focus:border-blue-500 focus:outline-none">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <select id="filterStatus" onchange="filterUsers()" 
                        class="bg-[#2a2a2a] text-white p-2 rounded border border-gray-700 focus:border-blue-500 focus:outline-none">
                    <option value="all">ุฌููุน ุงูุญุณุงุจุงุช</option>
                    <option value="active">ุงููุดุทุฉ</option>
                    <option value="expiring">ุชูุชูู ูุฑูุจุงู</option>
                    <option value="expired">ุงูููุชููุฉ</option>
                </select>
            </div>
        </div>

        <!-- ุฌุฏูู ุงููุณุชุฎุฏููู -->
        <div class="bg-[#2a2a2a] rounded-lg shadow-lg overflow-hidden">
            <div class="p-4 bg-[#3a3a3a]">
                <h2 class="text-xl font-bold mb-3">ูุงุฆูุฉ ุงููุณุชุฎุฏููู</h2>
                <!-- ููุงุญุธุฉ ุญูู ุงูุฃุฒุฑุงุฑ -->
                <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-3 text-sm">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-info-circle text-blue-400 ml-2"></i>
                        <span class="text-blue-300 font-medium">ุดุฑุญ ุงูุฃุฒุฑุงุฑ:</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                        <div class="flex items-center">
                            <i class="fas fa-edit text-blue-400 ml-1"></i>
                            <span class="text-gray-300">ุชุนุฏูู ุงูุจูุงูุงุช</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-plus text-purple-400 ml-1"></i>
                            <span class="text-gray-300">ุฅุถุงูุฉ ุงุดุชุฑุงู</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-sync-alt text-green-400 ml-1"></i>
                            <span class="text-gray-300">ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-ban text-yellow-400 ml-1"></i>
                            <span class="text-gray-300">ุฅูุบุงุก ุชูุนูู (ูุคูุช)</span>
                        </div>
                        <div class="flex items-center md:col-span-2">
                            <i class="fas fa-trash text-red-400 ml-1"></i>
                            <span class="text-gray-300">ุญุฐู ููุงุฆู (ุงููุณุชุฎุฏู + ุฌููุน ุงุดุชุฑุงูุงุชู)</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ุงูุนุฑุถ ุงูููุชุจู -->
            <div class="desktop-table table-container overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-[#3a3a3a]">
                        <tr>
                            <th class="px-6 py-3 text-right">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                            <th class="px-6 py-3 text-right">ูููุฉ ุงููุฑูุฑ</th>
                            <th class="px-6 py-3 text-right">ุฑูู ุงููุงุชุณุงุจ</th>
                            <th class="px-6 py-3 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                            <th class="px-6 py-3 text-right">ุชุงุฑูุฎ ุงูุงูุชูุงุก</th>
                            <th class="px-6 py-3 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-6 py-3 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody" class="divide-y divide-gray-700">
                    </tbody>
                </table>
            </div>
            
            <!-- ุงูุนุฑุถ ุงููุญููู -->
            <div class="mobile-view p-4" style="display: none;">
                <div id="usersMobileView">
                    <!-- ุณูุชู ููุก ุงูุจูุงูุงุช ููุง ููุฌูุงูุงุช -->
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู -->
    <div id="renewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-[#2a2a2a] rounded-lg w-full max-w-md p-6">
            <h3 class="text-lg font-bold mb-4">ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู</h3>
            <form id="renewForm" onsubmit="handleRenewSubscription(event)">
                <div class="mb-4">
                    <label class="block text-gray-400 mb-2">ูุฏุฉ ุงูุชุฌุฏูุฏ</label>
                    <select required class="w-full p-2 rounded bg-[#1a1a1a] border border-gray-700 focus:border-red-500">
                        <option value="1">ุดูุฑ ูุงุญุฏ</option>
                        <option value="3">3 ุฃุดูุฑ</option>
                        <option value="6">6 ุฃุดูุฑ</option>
                        <option value="12">ุณูุฉ</option>
                        <option value="custom">ูุฏุฉ ูุฎุตุตุฉ</option>
                    </select>
                </div>
                <div id="customDaysDiv" class="mb-4 hidden">
                    <label class="block text-gray-400 mb-2">ุนุฏุฏ ุงูุฃูุงู</label>
                    <input type="number" min="1" class="w-full p-2 rounded bg-[#1a1a1a] border border-gray-700 focus:border-red-500">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeRenewModal()" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
                        ุฅูุบุงุก
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 rounded hover:bg-green-700">
                        ุชุฌุฏูุฏ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ูููุฐุฌ ุฅุถุงูุฉ ุญุณุงุจ ุฌุฏูุฏ -->
    <div id="newUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-[#2a2a2a] rounded-lg w-full max-w-md">
            <div class="p-4 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold">ุฅุถุงูุฉ ุญุณุงุจ ุฌุฏูุฏ</h3>
                    <button onclick="closeNewUserModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <form id="newUserForm" onsubmit="handleNewUser(event)" class="p-4 space-y-4">
                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="far fa-envelope ml-2"></i>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
                    </label>
                    <input type="email" required 
                           class="w-full p-3 rounded bg-[#1a1a1a] text-white border border-gray-700 focus:border-red-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="fas fa-lock ml-2"></i>ูููุฉ ุงููุฑูุฑ
                    </label>
                    <input type="password" required 
                           class="w-full p-3 rounded bg-[#1a1a1a] text-white border border-gray-700 focus:border-red-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="fas fa-clock ml-2"></i>ูุฏุฉ ุงูุงุดุชุฑุงู
                    </label>
                    <select required class="w-full p-3 rounded bg-[#1a1a1a] text-white border border-gray-700 focus:border-red-500 focus:outline-none">
                        <option value="1">ุดูุฑ ูุงุญุฏ</option>
                        <option value="3">3 ุฃุดูุฑ</option>
                        <option value="6">6 ุฃุดูุฑ</option>
                        <option value="12">ุณูุฉ</option>
                        <option value="custom">ูุฏุฉ ูุฎุตุตุฉ</option>
                    </select>
                </div>

                <div id="customDurationDiv" class="hidden">
                    <label class="block text-gray-400 mb-2">
                        <i class="fas fa-calendar ml-2"></i>ุชุงุฑูุฎ ุงูุงูุชูุงุก
                    </label>
                    <input type="date" 
                           class="w-full p-3 rounded bg-[#1a1a1a] text-white border border-gray-700 focus:border-red-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="fab fa-whatsapp ml-2"></i>ุฑูู ุงููุงุชุณุงุจ
                    </label>
                    <div class="flex gap-2">
                        <select id="countryCode" class="w-24 p-2 rounded bg-[#1a1a1a] border border-gray-700">
                            <option value="+966">๐ธ๐ฆ +966</option>
                            <option value="+971">๐ฆ๐ช +971</option>
                            <option value="+974">๐ถ๐ฆ +974</option>
                            <option value="+965">๐ฐ๐ผ +965</option>
                            <option value="+973">๐ง๐ญ +973</option>
                            <option value="+968">๐ด๐ฒ +968</option>
                        </select>
                        <input type="tel" id="whatsapp" required
                               class="flex-1 p-2 rounded bg-[#1a1a1a] border border-gray-700">
                    </div>
                </div>
                
                <div class="flex justify-end pt-4 border-t border-gray-700">
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                        ุฅูุดุงุก ุงูุญุณุงุจ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ูููุฐุฌ ุชุนุฏูู ุจูุงูุงุช ุงููุณุชุฎุฏู -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-[#2a2a2a] rounded-lg w-full max-w-md">
            <div class="p-4 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold">ุชุนุฏูู ุจูุงูุงุช ุงููุณุชุฎุฏู</h3>
                    <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <form id="editUserForm" onsubmit="handleEditUser(event)" class="p-4 space-y-4">
                <input type="hidden" id="editUserId">
                
                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="far fa-envelope ml-2"></i>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
                    </label>
                    <input type="email" id="editUserEmail" required readonly
                           class="w-full p-3 rounded bg-[#1a1a1a] text-gray-400 border border-gray-700">
                </div>
                
                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="fab fa-whatsapp ml-2"></i>ุฑูู ุงููุงุชุณุงุจ
                    </label>
                    <div class="flex gap-2">
                        <select id="editUserWhatsappCode" class="w-24 p-2 rounded bg-[#1a1a1a] border border-gray-700">
                            <option value="+966">๐ธ๐ฆ +966</option>
                            <option value="+971">๐ฆ๐ช +971</option>
                            <option value="+974">๐ถ๐ฆ +974</option>
                            <option value="+965">๐ฐ๐ผ +965</option>
                            <option value="+973">๐ง๐ญ +973</option>
                            <option value="+968">๐ด๐ฒ +968</option>
                        </select>
                        <input type="tel" id="editUserWhatsapp" required
                               class="flex-1 p-2 rounded bg-[#1a1a1a] border border-gray-700">
                    </div>
                </div>

                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="fas fa-lock ml-2"></i>ูููุฉ ุงููุฑูุฑ (ุงุชุฑููุง ูุงุฑุบุฉ ููุงุญุชูุงุธ ุจูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ)
                    </label>
                    <input type="password" id="editUserPassword"
                           class="w-full p-3 rounded bg-[#1a1a1a] text-white border border-gray-700">
                </div>

                <div>
                    <label class="block text-gray-400 mb-2">
                        <i class="far fa-calendar ml-2"></i>ุชุงุฑูุฎ ุงูุงูุชูุงุก
                    </label>
                    <input type="date" id="editUserExpiry"
                           class="w-full p-3 rounded bg-[#1a1a1a] text-white border border-gray-700">
                </div>
                
                <div class="flex justify-end pt-4 border-t border-gray-700">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                        ุญูุธ ุงูุชุบููุฑุงุช
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ูุญุต ุจุณูุท ุฌุฏุงู ูููุฏูุฑ (ูุญุณูู ูุชุญููู ุงูุฃุฎุทุงุก)
        function simpleAdminCheck() {
            console.log('๐ ูุญุต ุตูุงุญูุงุช ุงููุฏูุฑ...');

            // Helper ูุชุญููู ุงูููู ุงููุตูุฉ ุฅูู ููุทููุฉ
            const asTruthy = (v) => v === true || v === 'true' || v === 1 || v === '1' || v === 'yes' || v === 'YES' || v === 'True';

            let rawUser = localStorage.getItem('userData');
            let userData = {};
            if (rawUser) {
                try {
                    userData = JSON.parse(rawUser);
                } catch (e1) {
                    // ุฌุฑูุจ ูู Base64 ุซู JSON ุฅุฐุง ูุงูุช ุงููููุฉ ูุดููุฑุฉ ุณุงุจูุงู
                    try {
                        const decoded = decodeURIComponent(atob(rawUser));
                        userData = JSON.parse(decoded);
                    } catch (e2) {
                        console.warn('โ๏ธ ุชุนุฐุฑ ูุฑุงุกุฉ userData ุจุฃู ุตูุบุฉุ ุณูุชู ุชุฌุงูููุง ูุคูุชุงู:', { e1, e2, rawUser });
                        userData = {};
                    }
                }
            }

            const isLoggedInRaw = localStorage.getItem('isLoggedIn');
            const loggedIn = asTruthy(isLoggedInRaw);
            const email = (userData.email || '').toLowerCase().trim();
            const isAdmin = asTruthy(userData.isAdmin) || asTruthy(userData.is_admin);

            console.log('๐ ุจูุงูุงุช ุงููุณุชุฎุฏู:', userData);
            console.log('๐ ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู (raw):', isLoggedInRaw, '=> normalized:', loggedIn);
            console.log('๐ง ุงูุจุฑูุฏ:', email, '๐ isAdmin:', isAdmin);

            if ((loggedIn && email === 'mtjgrwolf@gmail.com') || isAdmin) {
                console.log('โ ุชู ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุฏูุฑ');
                return true;
            }

            if (!loggedIn) {
                console.log('โ ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู');
                alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
                window.location.href = 'login.html';
                return false;
            }

            console.log('โ ุงููุณุชุฎุฏู ููุณ ูุฏูุฑ');
            alert('ุบูุฑ ูุตุฑุญ ูู ุจุงููุตูู ููุฐู ุงูุตูุญุฉ');
            window.location.href = 'dashboard.html';
            return false;
        }
        
        // ุงูุชุญูู ุจุงุณุชุฎุฏุงู MCP ูุจุงุดุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        async function checkWithMCP(email) {
            try {
                console.log('๐ ุงูุชุญูู ูู ุงููุฏูุฑ ุจุงุณุชุฎุฏุงู MCP...');
                
                // ุงูุชุญูู ูู ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูู ูููุฏูุฑ ุงููุนุชูุฏ
                if (email !== 'mtjgrwolf@gmail.com') {
                    console.log('โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุญูุญ ูููุฏูุฑ');
                    blockAccess('ุบูุฑ ูุตุฑุญ ูู ุจุงููุตูู ููุฐู ุงูุตูุญุฉ');
                    return false;
                }
                
                // ูุญุงูุงุฉ ุงุณุชุฏุนุงุก MCP ููุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                // ูู ุงูุชุทุจูู ุงูุญููููุ ูุฐุง ุณูููู ุงุณุชุฏุนุงุก ูุนูู ูู MCP
                const mcpResult = await simulateMCPCall(email);
                
                if (mcpResult && mcpResult.isAdmin) {
                    console.log('โ ุชู ุงูุชุญูู ูู ุงููุฏูุฑ ุจุงุณุชุฎุฏุงู MCP');
                    return true;
                }
                
                console.log('โ ูุดู ุงูุชุญูู ูู MCP - ุงููุณุชุฎุฏู ููุณ ูุฏูุฑ');
                blockAccess('ุบูุฑ ูุตุฑุญ ูู ุจุงููุตูู ููุฐู ุงูุตูุญุฉ');
                return false;
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู MCP:', error);
                blockAccess('ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช');
                return false;
            }
        }
        
        // ูุญุงูุงุฉ ุงุณุชุฏุนุงุก MCP (ูู ุงูุชุทุจูู ุงูุญูููู ุณูููู ุงุณุชุฏุนุงุก ูุนูู)
        async function simulateMCPCall(email) {
            // ูุญุงูุงุฉ ุงููุชูุฌุฉ ุงููุนููุฉ ูู MCP
            // ุงููุชูุฌุฉ ุงููุนููุฉ ูู MCP: [{"email":"mtjgrwolf@gmail.com","is_admin":true}]
            if (email === 'mtjgrwolf@gmail.com') {
                return {
                    email: 'mtjgrwolf@gmail.com',
                    isAdmin: true
                };
            }
            return null;
        }
        
        // ุญุธุฑ ุงููุตูู
        function blockAccess(message) {
            document.body.innerHTML = `
                <div class="min-h-screen bg-red-900 flex items-center justify-center">
                    <div class="text-center text-white p-8 max-w-md mx-auto">
                        <i class="fas fa-shield-alt text-6xl mb-4 text-red-300"></i>
                        <h1 class="text-2xl font-bold mb-4">๐ซ ูุตูู ูุญุธูุฑ</h1>
                        <p class="mb-6 text-red-200">${message}</p>
                        <div class="space-y-3">
                            <a href="login.html" class="block bg-red-600 px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                                <i class="fas fa-sign-in-alt ml-2"></i>
                                ุชุณุฌูู ุงูุฏุฎูู
                            </a>
                            <a href="dashboard.html" class="block bg-gray-600 px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-home ml-2"></i>
                                ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
                            </a>
                        </div>
                        <p class="mt-6 text-sm text-red-300">
                            <i class="fas fa-info-circle ml-1"></i>
                            ูุฐู ุงูุตูุญุฉ ูุฎุตุตุฉ ูููุฏูุฑ ููุท
                        </p>
                    </div>
                </div>
            `;
            
            // ุฅุนุงุฏุฉ ุชูุฌูู ุชููุงุฆูุฉ ุจุนุฏ 5 ุซูุงู
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 5000);
        }

        // ุญูุงูุฉ ุฅุถุงููุฉ ูู ุงููุตูู ุงููุจุงุดุฑ
        class DirectAccessProtection {
            constructor() {
                this.init();
            }

            init() {
                // ููุน ุงููุณุฎ ูุงููุตู
                document.addEventListener('copy', this.preventAction);
                document.addEventListener('cut', this.preventAction);
                document.addEventListener('paste', this.preventAction);
                
                // ููุน ุงูููุฑ ุจุงูุฒุฑ ุงูุฃููู
                document.addEventListener('contextmenu', this.preventAction);
                
                // ููุน ุงุฎุชุตุงุฑุงุช ุงููุทูุฑ
                document.addEventListener('keydown', this.preventDevTools);
                
                // ููุน ุงูุณุญุจ ูุงูุฅููุงุช
                document.addEventListener('dragstart', this.preventAction);
                
                // ูุฑุงูุจุฉ ุชุบููุฑ ุญุฌู ุงููุงูุฐุฉ (ูุฏ ูุดูุฑ ููุชุญ ุฃุฏูุงุช ุงููุทูุฑ)
                this.originalHeight = window.outerHeight;
                this.originalWidth = window.outerWidth;
                setInterval(() => this.checkDevTools(), 1000);
                
                // ุญูุงูุฉ ูู ุงูุชูุงุนุจ ุจู localStorage
                this.protectLocalStorage();
            }

            preventAction(e) {
                e.preventDefault();
                return false;
            }

            preventDevTools(e) {
                 // ููุน F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
                 if (e.keyCode === 123 || 
                     (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                     (e.ctrlKey && e.keyCode === 85)) {
                     e.preventDefault();
                     alert('ูุญุงููุฉ ูุตูู ุบูุฑ ูุตุฑุญ ุจูุง');
                     return false;
                 }
             }

             checkDevTools() {
                 const heightDiff = window.outerHeight - window.innerHeight;
                 const widthDiff = window.outerWidth - window.innerWidth;
                 
                 if (heightDiff > 200 || widthDiff > 200) {
                     alert('ุชู ุงูุชุดุงู ูุญุงููุฉ ูุชุญ ุฃุฏูุงุช ุงููุทูุฑ');
                 }
             }

            protectLocalStorage() {
                // ุชุดููุฑ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ
                const originalSetItem = localStorage.setItem;
                const originalGetItem = localStorage.getItem;
                
                localStorage.setItem = function(key, value) {
                    const skipKeys = ['isLoggedIn', 'userData'];
                    if (skipKeys.includes(key)) {
                        // ูุง ุชุดููุฑ ููุฐู ุงูููุงุชูุญ ูุถูุงู ุงูุชูุงูู
                        return originalSetItem.call(this, key, value);
                    }
                    if (key.includes('admin') || key.includes('user') || key.includes('session')) {
                        value = btoa(encodeURIComponent(value)); // ุชุดููุฑ ุจุณูุท
                    }
                    return originalSetItem.call(this, key, value);
                };
                
                localStorage.getItem = function(key) {
                    const skipKeys = ['isLoggedIn', 'userData'];
                    if (skipKeys.includes(key)) {
                        // ูุง ูู ุชุดููุฑ ููุฐู ุงูููุงุชูุญ
                        return originalGetItem.call(this, key);
                    }
                    let value = originalGetItem.call(this, key);
                    if (value && (key.includes('admin') || key.includes('user') || key.includes('session'))) {
                        try {
                            return decodeURIComponent(atob(value)); // ูู ุงูุชุดููุฑ
                        } catch (e) {
                            // ุฅุฐุง ูุงูุช ุงููููุฉ ุบูุฑ ูุดูุฑุฉ ูุณุจูุงูุ ูุนูุฏูุง ููุง ูู ูุถูุงู ุงูุชูุงูู
                            return value;
                        }
                    }
                    return value;
                };
            }
        }

        // ุชูุนูู ุงูุญูุงูุฉ ุงูุฅุถุงููุฉ
        const directAccessProtection = new DirectAccessProtection();

        // ุฏุงูุฉ ูุญุต ุงููุฏูุฑ ุงููุญุฏุซุฉ - ุจุณูุทุฉ
        function checkAdmin() {
            return simpleAdminCheck();
        }

        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        async function updateStats() {
            try {
                const result = await dbManager.getAllUsers();

                if (result.success) {
                    const users = result.users;
                    const now = new Date();
                    const sevenDaysFromNow = new Date();
                    sevenDaysFromNow.setDate(now.getDate() + 7);

                    const stats = {
                        total: users.length,
                        active: 0,
                        expiring: 0,
                        expired: 0
                    };

                    // ููุชุฑุฉ ุงููุณุชุฎุฏููู ูุฅุฎูุงุก ุญุณุงุจ ุงููุฏูุฑ ูู ุงูุฅุญุตุงุฆูุงุช
                const filteredUsers = users.filter(user => !user.is_admin);
                
                // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ูููุณุชุฎุฏููู ุงูุนุงุฏููู ููุท
                stats.total = filteredUsers.length;
                
                filteredUsers.forEach(user => {
                    if (!user.expiry_date) {
                        return;
                    }

                    const expiryDate = new Date(user.expiry_date);
                    if (expiryDate > now && user.is_active) {
                        stats.active++;
                        if (expiryDate <= sevenDaysFromNow) {
                            stats.expiring++;
                        }
                    } else {
                        stats.expired++;
                    }
                });

                    document.getElementById('totalAccounts').textContent = stats.total;
                    document.getElementById('activeAccounts').textContent = stats.active;
                    document.getElementById('expiringAccounts').textContent = stats.expiring;
                    document.getElementById('expiredAccounts').textContent = stats.expired;
                } else {
                    console.error('Error loading users:', result.error);
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // ููุชุฑุฉ ุงููุณุชุฎุฏููู
        async function filterUsers() {
            try {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filterStatus = document.getElementById('filterStatus').value;
                const now = new Date();
                const sevenDaysFromNow = new Date();
                sevenDaysFromNow.setDate(now.getDate() + 7);

                // ุฌูุจ ุงููุณุชุฎุฏููู ูู ูุฏูุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Supabase)
                const result = await dbManager.getAllUsers();
                if (!result.success) {
                    console.error('Error loading users for filter:', result.error);
                    return;
                }

                const users = result.users || [];

                const filteredUsers = users.filter(user => {
                    // ุฅุฎูุงุก ุญุณุงุจ ุงููุฏูุฑ ูู ุงููุชุงุฆุฌ
                    if (user.is_admin) return false;
                    
                    const email = (user.email || '').toLowerCase();
                    const matchesSearch = email.includes(searchTerm);

                    const expiryDate = user.expiry_date ? new Date(user.expiry_date) : null;
                    const isActive = user.is_active !== false;

                    switch (filterStatus) {
                        case 'active':
                            return matchesSearch && !!expiryDate && expiryDate > now && isActive;
                        case 'expiring':
                            return matchesSearch && !!expiryDate && expiryDate > now && expiryDate <= sevenDaysFromNow && isActive;
                        case 'expired':
                            return matchesSearch && ((!!expiryDate && expiryDate <= now) || !isActive);
                        default:
                            return matchesSearch;
                    }
                });

                await updateUsersTable(filteredUsers);
            } catch (error) {
                console.error('Error filtering users:', error);
            }
        }

        // ุชุญุฏูุซ ุฌุฏูู ุงููุณุชุฎุฏููู
        async function updateUsersTable(users = null) {
            try {
                if (users === null) {
                    const result = await dbManager.getAllUsers();
                    if (result.success) {
                        users = result.users;
                    } else {
                        console.error('Error loading users:', result.error);
                        return;
                    }
                }

                const tbody = document.getElementById('usersTableBody');
                const mobileView = document.getElementById('usersMobileView');
                tbody.innerHTML = '';
                mobileView.innerHTML = '';

                // ููุชุฑุฉ ุงููุณุชุฎุฏููู ูุฅุฎูุงุก ุญุณุงุจ ุงููุฏูุฑ
                const filteredUsers = users.filter(user => !user.is_admin);
                
                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    const now = new Date();

                    let statusText = '';
                    let statusClass = '';
                    let daysLeft = 0;

                    if (user.is_admin) {
                        statusText = 'ูุฏูุฑ';
                        statusClass = 'bg-purple-500/20 text-purple-500';
                    } else if (!user.expiry_date) {
                        statusText = 'ุบูุฑ ูุญุฏุฏ';
                        statusClass = 'bg-gray-500/20 text-gray-500';
                    } else {
                        const expiryDate = new Date(user.expiry_date);
                        const isExpired = expiryDate < now;
                        daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

                        if (isExpired) {
                            statusText = 'ููุชูู';
                            statusClass = 'bg-red-500/20 text-red-500';
                        } else {
                            statusText = `ูุชุจูู ${daysLeft} ููู`;
                            statusClass = 'bg-green-500/20 text-green-500';
                        }
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4">${user.email}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-sm bg-gray-700 px-2 py-1 rounded select-all" 
                                      onclick="copyToClipboard('${user.password_hash ? user.password_hash.substring(0, 8) + '...' : 'password123'}')"
                                      title="ุงุถุบุท ูููุณุฎ - ูููุฉ ุงููุฑูุฑ ุงููุดูุฑุฉ">
                                    ${user.password_hash ? user.password_hash.substring(0, 8) + '...' : 'password123'}
                                </span>
                                <button onclick="copyToClipboard('${user.password_hash ? user.password_hash.substring(0, 8) + '...' : 'password123'}')"
                                        class="text-blue-500 hover:text-blue-600 text-xs" 
                                        title="ูุณุฎ ูููุฉ ุงููุฑูุฑ">
                                    <i class="fas fa-copy"></i>
                                </button>
                                ${!user.is_admin && user.password_hash ? `
                                    <button onclick="resetUserPassword('${user.id}', '${user.email}')" 
                                            class="text-orange-500 hover:text-orange-600 text-xs" 
                                            title="ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ">
                                        <i class="fas fa-key"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${user.whatsapp ? `
                                <div class="flex items-center gap-2">
                                    <span class="select-all">${user.whatsapp}</span>
                                    <button onclick="copyToClipboard('${user.whatsapp}')"
                                            class="text-green-500 hover:text-green-600 text-xs" 
                                            title="ูุณุฎ ุฑูู ุงููุงุชุณุงุจ">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                </div>
                            ` : '-'}
                        </td>
                        <td class="px-6 py-4">${new Date(user.created_at).toLocaleDateString('ar-SA')}</td>
                        <td class="px-6 py-4">${user.expiry_date ? new Date(user.expiry_date).toLocaleDateString('ar-SA') : '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-sm ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                ${!user.is_admin ? `
                                    <button onclick="openEditUser('${user.id}')" class="text-blue-500 hover:text-blue-600" title="ุชุนุฏูู">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="openRenewModal('${user.id}')"
                                            class="text-green-500 hover:text-green-600" title="ุชุฌุฏูุฏ">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button onclick="terminateUser('${user.id}')"
                                            class="text-yellow-500 hover:text-yellow-600" title="ุฅูุบุงุก ุชูุนูู">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    <button onclick="deleteUser('${user.id}')"
                                            class="text-red-500 hover:text-red-600" title="ุญุฐู ููุงุฆู">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : '<span class="text-gray-500">ูุฏูุฑ</span>'}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // ุฅูุดุงุก ุจุทุงูุฉ ููุนุฑุถ ุงููุญููู
                    const mobileCard = document.createElement('div');
                    mobileCard.className = 'mobile-card';
                    mobileCard.innerHTML = `
                        <div class="mobile-card-header">
                            <div class="mobile-card-title">${user.email}</div>
                            <span class="px-2 py-1 rounded text-sm ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="mobile-card-body">
                            <div class="mobile-field">
                                   <span class="mobile-field-label">ูููุฉ ุงููุฑูุฑ</span>
                                   <div class="flex items-center gap-2">
                                       <span class="mobile-field-value font-mono text-sm bg-gray-700 px-2 py-1 rounded select-all"
                                               onclick="copyToClipboard('${user.password_hash ? user.password_hash.substring(0, 8) + '...' : 'password123'}')"
                                               title="ุงุถุบุท ูููุณุฎ - ูููุฉ ุงููุฑูุฑ ุงููุดูุฑุฉ">
                                             ${user.password_hash ? user.password_hash.substring(0, 8) + '...' : 'password123'}
                                         </span>
                                         <button onclick="copyToClipboard('${user.password_hash ? user.password_hash.substring(0, 8) + '...' : 'password123'}')"
                                                 class="text-blue-500 hover:text-blue-600 text-xs" 
                                                 title="ูุณุฎ ูููุฉ ุงููุฑูุฑ">
                                             <i class="fas fa-copy"></i>
                                         </button>
                                       ${!user.is_admin && user.password_hash ? `
                                           <button onclick="resetUserPassword('${user.id}', '${user.email}')" 
                                                   class="text-orange-500 hover:text-orange-600 text-xs" 
                                                   title="ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ">
                                               <i class="fas fa-key"></i>
                                           </button>
                                       ` : ''}
                                   </div>
                               </div>
                            <div class="mobile-field">
                                 <span class="mobile-field-label">ุฑูู ุงููุงุชุณุงุจ</span>
                                 ${user.whatsapp ? `
                                     <div class="flex items-center gap-2">
                                         <span class="mobile-field-value select-all">${user.whatsapp}</span>
                                         <button onclick="copyToClipboard('${user.whatsapp}')"
                                                 class="text-green-500 hover:text-green-600 text-xs" 
                                                 title="ูุณุฎ ุฑูู ุงููุงุชุณุงุจ">
                                             <i class="fab fa-whatsapp"></i>
                                         </button>
                                     </div>
                                 ` : '<span class="mobile-field-value">-</span>'}
                             </div>
                            <div class="mobile-field">
                                <span class="mobile-field-label">ุชุงุฑูุฎ ุงูุฅูุดุงุก</span>
                                <span class="mobile-field-value">${new Date(user.created_at).toLocaleDateString('ar-SA')}</span>
                            </div>
                            <div class="mobile-field">
                                <span class="mobile-field-label">ุชุงุฑูุฎ ุงูุงูุชูุงุก</span>
                                <span class="mobile-field-value">${user.expiry_date ? new Date(user.expiry_date).toLocaleDateString('ar-SA') : '-'}</span>
                            </div>
                            ${!user.is_admin && daysLeft > 0 ? `
                                <div class="mobile-field">
                                    <span class="mobile-field-label">ุงูุฃูุงู ุงููุชุจููุฉ</span>
                                    <span class="mobile-field-value text-${daysLeft <= 7 ? 'yellow' : 'green'}-500">${daysLeft} ููู</span>
                                </div>
                            ` : ''}
                        </div>
                        ${!user.is_admin ? `
                            <div class="mobile-actions">
                                <button onclick="openEditUser('${user.id}')" class="bg-blue-600 hover:bg-blue-700 text-white rounded" title="ุชุนุฏูู">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="openRenewModal('${user.id}')" class="bg-green-600 hover:bg-green-700 text-white rounded" title="ุชุฌุฏูุฏ">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="terminateUser('${user.id}')" class="bg-yellow-600 hover:bg-yellow-700 text-white rounded" title="ุฅูุบุงุก ุชูุนูู">
                                    <i class="fas fa-ban"></i>
                                </button>
                                <button onclick="deleteUser('${user.id}')" class="bg-red-600 hover:bg-red-700 text-white rounded" title="ุญุฐู ููุงุฆู">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : `
                            <div class="mobile-actions">
                                <div class="text-center text-gray-500 py-2">ุญุณุงุจ ูุฏูุฑ</div>
                            </div>
                        `}
                    `;
                    mobileView.appendChild(mobileCard);
                });
            } catch (error) {
                console.error('Error updating users table:', error);
            }
        }

        let currentUserId = '';

        function openRenewModal(userId) {
            currentUserId = userId;
            document.getElementById('renewModal').classList.remove('hidden');
        }

        function closeRenewModal() {
            document.getElementById('renewModal').classList.add('hidden');
            currentUserId = '';
        }

        async function handleRenewSubscription(event) {
            event.preventDefault();
            if (!currentUserId) return;

            const form = event.target;
            const duration = form.querySelector('select').value;
            const customDays = form.querySelector('input[type="number"]')?.value;

            const now = new Date();
            let expiryDate = new Date();

            if (duration === 'custom' && customDays) {
                expiryDate.setDate(now.getDate() + parseInt(customDays));
            } else {
                expiryDate.setMonth(now.getMonth() + parseInt(duration));
            }

            try {
                const updateRes = await dbManager.updateUserProfile(currentUserId, { expiry_date: expiryDate.toISOString(), is_active: true });
                if (!updateRes.success) {
                    alert(updateRes.error || 'ูุดู ูู ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู');
                    return;
                }
                closeRenewModal();
                await updateUsersTable();
                alert('ุชู ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู ุจูุฌุงุญ');
            } catch (error) {
                console.error('Error renewing subscription:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู');
            }
        }

        async function terminateUser(userId) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ุชูุนูู ูุฐุง ุงููุณุชุฎุฏูุ\n\nููุงุญุธุฉ: ุฅูุบุงุก ุงูุชูุนูู ูููุน ุงููุณุชุฎุฏู ูู ุชุณุฌูู ุงูุฏุฎูู ููู ูุญุชูุธ ุจุจูุงูุงุชู.')) return;

            try {
                const result = await dbManager.deactivateUser(userId);

                if (result.success) {
                    await updateStats();
                    await updateUsersTable();
                    alert('ุชู ุฅูุบุงุก ุชูุนูู ุงููุณุชุฎุฏู ุจูุฌุงุญ');
                } else {
                    alert(result.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุบุงุก ุชูุนูู ุงููุณุชุฎุฏู');
                }
            } catch (error) {
                console.error('Error deactivating user:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุบุงุก ุชูุนูู ุงููุณุชุฎุฏู');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('โ๏ธ ุชุญุฐูุฑ: ุญุฐู ููุงุฆู!\n\nูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณุชุฎุฏู ููุงุฆูุงูุ\n\nุณูุชู ุญุฐู:\n- ุญุณุงุจ ุงููุณุชุฎุฏู\n- ุฌููุน ุงุดุชุฑุงูุงุชู\n- ุฌููุน ุจูุงูุงุชู\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!')) return;

            // ุชุฃููุฏ ุฅุถุงูู
            const confirmText = prompt('ููุชุฃููุฏุ ุงูุชุจ "ุญุฐู ููุงุฆู" ูุญุฐู ุงููุณุชุฎุฏู:');
            if (confirmText !== 'ุญุฐู ููุงุฆู') {
                alert('ุชู ุฅูุบุงุก ุงูุนูููุฉ');
                return;
            }

            try {
                const result = await dbManager.deleteUser(userId);

                if (result.success) {
                    await updateStats();
                    await updateUsersTable();
                    alert('โ ุชู ุญุฐู ุงููุณุชุฎุฏู ูุฌููุน ุจูุงูุงุชู ููุงุฆูุงู');
                } else {
                    alert(result.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุณุชุฎุฏู');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุณุชุฎุฏู');
            }
        }

        // ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ
        async function resetUserPassword(userId, userEmail) {
            const newPassword = prompt(`ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ ูููุณุชุฎุฏู:\n${userEmail}\n\nุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ:`);
            
            if (!newPassword) {
                alert('ุชู ุฅูุบุงุก ุงูุนูููุฉ');
                return;
            }

            if (newPassword.length < 6) {
                alert('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู');
                return;
            }

            try {
                const result = await dbManager.updateUserPassword(userId, newPassword);

                if (result.success) {
                    alert(`โ ุชู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ\n\nูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ: ${newPassword}\n\nูุฑุฌู ุฅุจูุงุบ ุงููุณุชุฎุฏู ุจูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ`);
                    await updateUsersTable();
                } else {
                    alert(result.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ');
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ');
            }
        }

        // ูุณุฎ ุงููุต ุฅูู ุงูุญุงูุธุฉ
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    console.error('ูุดู ูู ุงููุณุฎ:', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        // ุทุฑููุฉ ุจุฏููุฉ ูููุณุฎ
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    alert('ูุดู ูู ูุณุฎ ุงููุต');
                }
            } catch (err) {
                console.error('ูุดู ูู ุงููุณุฎ:', err);
                alert('ูุดู ูู ูุณุฎ ุงููุต');
            }
            
            document.body.removeChild(textArea);
        }

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ุงููุณุฎ
        function showCopySuccess() {
            const toast = document.createElement('div');
            toast.textContent = 'โ ุชู ุงููุณุฎ ุจูุฌุงุญ';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }

        // ุชุญุฏูุซ ุญูู ุงููุฏุฉ ุงููุฎุตุตุฉ
        document.querySelector('select').addEventListener('change', function() {
            const customDaysDiv = document.getElementById('customDaysDiv');
            if (this.value === 'custom') {
                customDaysDiv.classList.remove('hidden');
                customDaysDiv.querySelector('input').required = true;
            } else {
                customDaysDiv.classList.add('hidden');
                customDaysDiv.querySelector('input').required = false;
            }
        });

        // ุชููุฆุฉ dbManager - ููุถู Supabase ููุฏูุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถู
        let dbManager;
        async function initializeDbManager() {
            try {
                if (typeof supabaseDbManager !== 'undefined') {
                    dbManager = supabaseDbManager; // ุงุณุชุฎุฏุงู Supabase ุฃููุงู
                } else if (typeof DatabaseManager !== 'undefined') {
                    dbManager = new DatabaseManager();
                    if (dbManager.waitForReady) {
                        await dbManager.waitForReady();
                    }
                } else {
                    throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ูุฏูุฑ ูุงุนุฏุฉ ุจูุงูุงุช ูุชุงุญ');
                }
                window.dbManager = dbManager;
            } catch (error) {
                console.error('Error initializing dbManager:', error);
                // ูุญุงููุฉ ุงุณุชุฎุฏุงู Supabase ูุญู ุฃุฎูุฑ
                if (typeof supabaseDbManager !== 'undefined') {
                    dbManager = supabaseDbManager;
                    window.dbManager = dbManager;
                }
            }
        }

        // ุชููุฆุฉ ุงูุตูุญุฉ ูุน ุงูุญูุงูุฉ ุงููุชูุฏูุฉ
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('๐ ุจุฏุก ุชููุฆุฉ ุงูุตูุญุฉ...');
                
                // ุงูุชุธุงุฑ ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
                if (window.envLoader) {
                    console.log('๐ง ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ...');
                    await window.envLoader.loadEnvironment();
                    console.log('โ ุชู ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ:', window.ENV);
                }
                
                // ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
                console.log('๐๏ธ ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช...');
                await initializeDbManager();
                
                // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงููุฏูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                console.log('๐ค ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงููุฏูุฑ...');
                if (window.dbManager && window.dbManager.ensureAdminExists) {
                    const adminResult = await window.dbManager.ensureAdminExists();
                    console.log('๐ ูุชูุฌุฉ ูุญุต ุงููุฏูุฑ:', adminResult);
                    if (adminResult.success && adminResult.created) {
                        console.log('โ ุชู ุฅูุดุงุก ุญุณุงุจ ุงููุฏูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
                    }
                }
                

                
                // ูุญุต ุตูุงุญูุงุช ุงููุฏูุฑ
                console.log('๐ ูุญุต ุตูุงุญูุงุช ุงููุฏูุฑ...');
                const hasAccess = checkAdmin();
                if (!hasAccess) {
                    return; // ุฅููุงู ุงูุชุญููู ุฅุฐุง ูู ููู ูุฏูู ุตูุงุญูุฉ
                }
                
                // ุชุญููู ุงูุจูุงูุงุช ููุท ุจุนุฏ ุงูุชุฃูุฏ ูู ุงูุตูุงุญูุงุช
                console.log('๐ ุชุญููู ุงูุจูุงูุงุช...');
                await updateStats();
                await updateUsersTable();
                
                // ุฅุถุงูุฉ ูุฑุงูุจ ูููุดุงุท ูุชุฌุฏูุฏ ุงูุฌูุณุฉ
                setupActivityMonitor();
                
                console.log('โ ุชู ุชููุฆุฉ ุงูุตูุญุฉ ุจูุฌุงุญ');
                
            } catch (error) {
                 console.error('โ ุฎุทุฃ ูู ุชููุฆุฉ ุงูุตูุญุฉ:', error);
                 alert('ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุตูุญุฉ');
                 window.location.href = 'login.html';
             }
        });

        // ูุฑุงูุจ ุงููุดุงุท ูุชุฌุฏูุฏ ุงูุฌูุณุฉ
        function setupActivityMonitor() {
            let activityTimer;
            const resetTimer = () => {
                clearTimeout(activityTimer);
                localStorage.setItem('lastActivity', Date.now().toString());
                activityTimer = setTimeout(() => {
                    alert('ุณุชูุชูู ุฌูุณุชู ุฎูุงู ุฏูููุฉ ูุงุญุฏุฉ ุจุณุจุจ ุนุฏู ุงููุดุงุท');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = 'login.html';
                    }, 60000);
                }, 30 * 60 * 1000); // 30 ุฏูููุฉ
            };
            
            // ูุฑุงูุจุฉ ุงููุดุงุท
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetTimer, true);
            });
            
            resetTimer(); // ุจุฏุก ุงููุคูุช
        }

        function openNewUserModal() {
            document.getElementById('newUserModal').classList.remove('hidden');
        }

        function closeNewUserModal() {
            document.getElementById('newUserModal').classList.add('hidden');
            document.getElementById('newUserForm').reset();
            document.getElementById('customDurationDiv').classList.add('hidden');
        }

        async function handleNewUser(event) {
            event.preventDefault();
            const form = event.target;
            const email = form.querySelector('input[type="email"]').value;
            const password = form.querySelector('input[type="password"]').value;
            const duration = form.querySelector('select').value;
            const countryCode = form.querySelector('#countryCode').value;
            const whatsappNumber = form.querySelector('#whatsapp').value;
            
            // ุชูููู ุฑูู ุงููุงุชุณุงุจ ุงููุงูู
            const whatsapp = whatsappNumber ? `${countryCode}${whatsappNumber}` : null;

            try {
                let durationMonths;
                if (duration === 'custom') {
                    const customDate = new Date(form.querySelector('input[type="date"]').value);
                    const now = new Date();
                    durationMonths = Math.ceil((customDate - now) / (1000 * 60 * 60 * 24 * 30));
                } else {
                    durationMonths = parseInt(duration);
                }

                const result = await dbManager.createUser(email, password, durationMonths, whatsapp);

                if (result.success) {
                    closeNewUserModal();
                    await updateStats();
                    await updateUsersTable();
                    alert('ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ');
                } else {
                    alert(result.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุญุณุงุจ');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุญุณุงุจ');
            }

            // ุชู ุฅุฒุงูุฉ ุญูุธ ุงููุณุชุฎุฏู ูู localStorage - ุงูุงุนุชูุงุฏ ุนูู Supabase ููุท
        }

        // ุฅุถุงูุฉ ูุณุชูุน ูุชุบููุฑ ูุฏุฉ ุงูุงุดุชุฑุงู
        document.querySelector('#newUserForm select').addEventListener('change', function() {
            const customDurationDiv = document.getElementById('customDurationDiv');
            const dateInput = customDurationDiv.querySelector('input[type="date"]');
            
            if (this.value === 'custom') {
                customDurationDiv.classList.remove('hidden');
                dateInput.required = true;
            } else {
                customDurationDiv.classList.add('hidden');
                dateInput.required = false;
            }
        });

        // ุฏุงูุฉ ูุชุญ ูููุฐุฌ ุชุนุฏูู ุงููุณุชุฎุฏู
        async function openEditUser(userId) {
            try {
                const result = await dbManager.getAllUsers();
                if (result.success) {
                    const user = result.users.find(u => u.id === userId);

                    if (user) {
                        document.getElementById('editUserId').value = user.id;
                        document.getElementById('editUserEmail').value = user.email;

                        if (user.whatsapp) {
                            const whatsapp = user.whatsapp.toString();
                            if (whatsapp.startsWith('+966')) {
                                document.getElementById('editUserWhatsappCode').value = '+966';
                                document.getElementById('editUserWhatsapp').value = whatsapp.substring(4);
                            } else {
                                document.getElementById('editUserWhatsappCode').value = '+966';
                                document.getElementById('editUserWhatsapp').value = whatsapp;
                            }
                        }

                        // ุชุนุจุฆุฉ ุชุงุฑูุฎ ุงูุงูุชูุงุก ุฅุฐุง ูุงู ููุฌูุฏุงู
                        if (user.expiry_date) {
                            const expiryDate = new Date(user.expiry_date);
                            const formattedDate = expiryDate.toISOString().split('T')[0];
                            document.getElementById('editUserExpiry').value = formattedDate;
                        }

                        document.getElementById('editUserModal').classList.remove('hidden');
                    }
                } else {
                    alert('ูุดู ูู ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู');
            }
        }

        // ุฏุงูุฉ ุฅุบูุงู ูููุฐุฌ ุงูุชุนุฏูู
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('editUserForm').reset();
        }

        // ุฏุงูุฉ ูุนุงูุฌุฉ ุชุนุฏูู ุจูุงูุงุช ุงููุณุชุฎุฏู
        async function handleEditUser(event) {
            event.preventDefault();
            try {
                const userId = document.getElementById('editUserId').value;
                const email = document.getElementById('editUserEmail').value;
                const password = document.getElementById('editUserPassword').value;
                const countryCode = document.getElementById('editUserWhatsappCode').value;
                const whatsapp = document.getElementById('editUserWhatsapp').value;
                const expiryInput = document.getElementById('editUserExpiry');
                const expiryDateVal = expiryInput && expiryInput.value ? new Date(expiryInput.value) : null;

                const profileData = {};
                if (whatsapp) profileData.whatsapp = `${countryCode}${whatsapp}`;
                if (expiryDateVal) profileData.expiry_date = new Date(expiryDateVal.setHours(23,59,59,999)).toISOString();

                if (Object.keys(profileData).length > 0) {
                    const updateRes = await dbManager.updateUserProfile(userId, profileData);
                    if (!updateRes.success) {
                        alert(updateRes.error || 'ูุดู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู');
                        return;
                    }
                }

                if (password && password.trim().length > 0) {
                    const passRes = await dbManager.updateUserPassword(userId, password.trim());
                    if (!passRes.success) {
                        alert(passRes.error || 'ูุดู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ');
                        return;
                    }
                }

                closeEditUserModal();
                await updateUsersTable();
                alert('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุจูุฌุงุญ');
            } catch (error) {
                console.error('Error updating user:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู');
            }
        }

    </script>


</body>
</html>
